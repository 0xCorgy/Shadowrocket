<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>模块助手</title>
  <link rel="icon" href="https://github.githubassets.com/favicons/favicon.svg" type="image/svg+xml" />
  <meta name="theme-color" content="#2563eb" />
  <style>
    :root {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --card: #f7f7f8;
      --border: #e5e7eb;
      --accent: #2563eb;

      --back-btn-bg: rgba(220, 220, 220, 0.3);
      --back-btn-color: #111;

      --radius: 12px;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0c0f;
        --fg: #e5e7eb;
        --muted: #a1a1aa;
        --card: #111317;
        --border: #25262b;
        --accent: #60a5fa;

        --back-btn-bg: rgba(120, 120, 120, 0.3);
        --back-btn-color: #e5e5e5;

        --shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand h1 {
      font-size: 18px;
      margin: 0;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: flex-start;
      justify-content: space-between;
      transition: all 0.3s ease;
      width: 100%;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex: 1;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="text"] {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--fg);
      outline: none;
      max-width: 360px;
      line-height: normal;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    button,
    .btn {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover,
    .btn:hover {
      background-color: var(--accent);
      color: #fff;
      transform: scale(1.03);
    }

    button:active,
    .btn:active {
      transform: scale(0.97);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(10px) scale(0.95);
      background: rgba(255, 255, 255, 0.9);
      color: #111;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-size: 12px;
      opacity: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 90vw;
      text-align: center;
      transition: opacity 0.2s ease, transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      z-index: 2000;
    }

    @media (prefers-color-scheme: dark) {
      .toast {
        background: rgba(50, 50, 50, 0.9);
        color: #e5e7eb;
      }
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0) scale(1);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      color: var(--muted);
      min-width: 50px;
      text-align: right;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 18px;
    }

    .card {
      grid-column: span 12;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @media(min-width:720px) {
      .card {
        grid-column: span 6;
      }
    }

    .card .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card .header-row h3 {
      margin: 0;
      font-size: 16px;
    }

    .card .meta {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      justify-content: space-between;
    }

    .card .meta button {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
    }

    .card pre {
      margin: 10px 0;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding: 10px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 13px;
    }

    .progress-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .progress {
      height: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden;
      flex: 1;
      transition: all 0.2s ease;
    }

    .progress>i {
      display: block;
      height: 100%;
      width: 0;
      background: var(--accent);
      transition: width 0.2s ease;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: var(--card);
      color: var(--fg);
      border-radius: var(--radius);
      max-width: 800px;
      width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      overflow: hidden;
      transform: scale(0.95);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .modal.show .modal-content {
      transform: scale(1);
    }

    .modal-content.small {
      max-width: 320px;
      width: 90%;
      max-height: 50%;
    }

    .modal-header {
      flex: 0 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--card);
      z-index: 10;
    }

    #modalBody {
      flex: 1 1 auto;
      padding: 12px 16px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      background: var(--card);
      border-radius: 0 0 var(--radius) var(--radius);
      font-size: 13px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 18px;
      color: var(--muted);
      padding: 2px 6px;
      border-radius: 6px;
      background: var(--card);
      transition: color 0.2s ease, transform 0.2s ease, background 0.2s ease;
    }

    .modal-close:hover {
      color: var(--accent);
      transform: scale(1.2);
      background: rgba(0, 0, 0, 0.05);
    }

    .confirm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: nowrap;
      padding: 12px 16px;
    }

    @media(max-width:600px) {
      .modal-content:not(.small) {
        width: 100%;
        height: 100%;
        border-radius: 0;
      }

      .modal-content.small {
        width: 90%;
        max-height: 40%;
        border-radius: var(--radius);
      }

      .modal-content.small #confirmBody {
        padding: 12px;
        font-size: 13px;
      }
    }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--back-btn-bg);
      color: var(--back-btn-color);
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      text-align: center;
      line-height: 1;
      transition: opacity 0.2s ease, transform 0.2s ease;
      opacity: 0;
      pointer-events: none;
    }

    #backToTop.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    #backToTop:hover {
      transform: scale(1.1);
      background-color: var(--accent);
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="https://github.githubassets.com/favicons/favicon.svg" width="24" height="24" alt="logo" />
        <h1>模块助手</h1>
      </div>

      <div class="controls-row">
        <div class="controls">
          <input id="q" type="text" placeholder="输入应用名称" autofocus />
          <button id="reload" class="btn">重新拉取</button>
        </div>
        <div class="progress-row" style="margin-top:6px;">
          <div class="progress"><i id="bar"></i></div>
          <span id="status" class="badge">已就绪</span>
        </div>
      </div>
    </div>

    <div id="results" class="grid"></div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>原始模块</h3>
        <span class="modal-close" id="modalClose">✕</span>
      </div>
      <pre id="modalBody"></pre>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h3>确认安装</h3>
        <span class="modal-close" id="confirmClose">✕</span>
      </div>
      <div id="confirmBody" style="padding:16px;font-size:14px;">是否安装此模块？</div>
      <div class="confirm-actions">
        <button id="confirmCancel" class="btn">取消</button>
        <button id="confirmOk" class="btn">确认</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <button id="backToTop" title="返回顶部">TOP</button>

  <script>
    (function () {
      const state = {
        owner: 'XiangwanGuan',
        repo: 'Shadowrocket',
        path: 'Release/Modules',
        apps: new Map(),
        extraModule: 'Module.sgmodule',
        pendingInstall: null
      };
      const CACHE_KEY = 'module_cache';
      const CACHE_EXPIRE = 60 * 60 * 1000;
      const $ = s => document.querySelector(s);

      const showToast = (msg) => {
        const el = $('#toast');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2000);
      };

      const setStatus = (t, p) => {
        const s = $('#status');
        if (s) s.textContent = t;
        const bar = $('#bar');
        if (bar) bar.style.width = (p || 0) + '%';
      };

      const extractDomains = txt => {
        const domains = new Set();
        txt.split(/\r?\n/).forEach(line => {
          if (/^hostname\s*=/.test(line.trim())) {
            let rhs = line.split('=')[1] || '';
            rhs = rhs.replace(/#.*/, '').trim();
            rhs = rhs.replace(/%APPEND%/g, '').trim();
            rhs.split(/[,\s]+/).filter(Boolean).forEach(d => domains.add(d));
          }
        });
        return domains;
      };

      const antiKill = txt => {
        const domains = new Set();
        txt.split(/\r?\n/).forEach(line => {
          if (/^hostname\s*=/.test(line.trim())) {
            let rhs = line.split('=')[1] || '';
            rhs = rhs.replace(/#.*/, '').trim();
            rhs = rhs.replace(/%APPEND%/g, '').trim();
            rhs.split(/[,\s]+/).filter(Boolean).forEach(d => domains.add(d.replace(/^-/, '')));
          }
        });
        if (!domains.size) return '';
        return `[MITM]\nhostname = %APPEND% ${[...domains].map(d => `-${d}`).join(',')}`;
      };

      const parseFile = (name, txt) => {
        const appName = name === 'Module.sgmodule' ? '融合模块' : name.replace(/\.sgmodule$/i, '');
        state.apps.set(appName, {
          domains: extractDomains(txt),
          raw: txt,
          rule: antiKill(txt),
          fileName: name
        });
      };

      const fuzzyMatch = (text, query) => {
        if (!query) return true;
        text = text.toLowerCase(); query = query.toLowerCase();
        if (text.includes(query)) return true;
        let i = 0;
        for (const c of text) { if (c === query[i]) i++; if (i === query.length) return true; }
        return false;
      };

      const renderResults = q => {
        const root = $('#results');
        root.innerHTML = '';
        const entries = [...state.apps.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        const matched = q ? entries.filter(([k]) => fuzzyMatch(k, q)) : entries;

        matched.forEach(([app, data]) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="header-row">
              <h3>${app}</h3>
              <span class="badge">解密域名：${data.domains.size}</span>
            </div>
            <div class="meta">
              <button class="btn" data-copy>反解密模块</button>
              <button class="btn" data-raw>查看原始模块</button>
              <button class="btn" data-install>安装此模块</button>
            </div>
            <pre class="code">${[...data.domains].join('\n')}</pre>
          `;
          root.appendChild(card);
        });
      };

      const attachEvents = () => {
        const modal = $('#modal');
        const closeBtn = $('#modalClose');
        const confirmModal = $('#confirmModal');
        const confirmClose = $('#confirmClose');
        const confirmCancel = $('#confirmCancel');
        const confirmOk = $('#confirmOk');

        $('#results').addEventListener('click', e => {
          const card = e.target.closest('.card'); if (!card) return;
          const app = card.querySelector('h3').innerText;
          const data = state.apps.get(app);

          if (e.target.matches('[data-copy]')) {
            if (!data.rule) { showToast('无可复制内容'); return; }
            const header = `#!name=反解密模块-${app}\n#!desc=请放置于模块列表下方\n`;
            navigator.clipboard.writeText(header + data.rule);
            showToast('已复制内容，请自行新建模块！');
          }

          if (e.target.matches('[data-raw]')) {
            $('#modalBody').textContent = data.raw;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
          }

          if (e.target.matches('[data-install]')) {
            state.pendingInstall = data.fileName;
            confirmModal.style.display = 'flex';
            setTimeout(() => confirmModal.classList.add('show'), 10);
          }
        });

        closeBtn.onclick = () => { modal.classList.remove('show'); setTimeout(() => modal.style.display = 'none', 200); };
        modal.onclick = e => { if (e.target.id === 'modal') closeBtn.click(); };

        confirmClose.onclick = () => { confirmModal.classList.remove('show'); setTimeout(() => confirmModal.style.display = 'none', 200); };
        confirmCancel.onclick = confirmClose.onclick;
        confirmModal.onclick = e => { if (e.target.id === 'confirmModal') confirmClose.click(); };

        confirmOk.onclick = () => {
          if (state.pendingInstall) {
            const moduleName = encodeURIComponent(state.pendingInstall);
            const url = `https://xiangwanguan.github.io/Shadowrocket/Static/Redirect.html?url=shadowrocket://install?module=https://xiangwanguan.github.io/Shadowrocket/Release/Modules/${moduleName}`;
            window.open(url, '_blank');
          }
          confirmClose.click();
        };

        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') {
            if (modal.classList.contains('show')) closeBtn.click();
            if (confirmModal.classList.contains('show')) confirmClose.click();
          }
        });
      };

      const fetchJSON = async url => {
        const r = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
        if (!r.ok) throw new Error(r.status + ': ' + (await r.text()));
        return r.json();
      };

      const saveToCache = () => {
        const appsArray = [...state.apps.entries()];
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), apps: appsArray }));
      };

      const loadFromCache = () => {
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if (!raw) return false;
          const data = JSON.parse(raw);
          if (Date.now() - data.ts > CACHE_EXPIRE) return false;
          state.apps = new Map(data.apps);
          renderResults($('#q').value.trim());
          setStatus(`已从缓存加载：${state.apps.size}个应用`, 100);
          return true;
        } catch {
          return false;
        }
      };

      const load = async () => {
        setStatus('正在准备数据', 5);

        const list = await fetchJSON(`https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}`);
        const files = list.filter(x => x.type === 'file');

        files.push({
          name: state.extraModule,
          download_url: `https://raw.githubusercontent.com/${state.owner}/${state.repo}/main/Release/${state.extraModule}`
        });

        let done = 0;
        const batchSize = 20;

        for (let i = 0; i < files.length; i += batchSize) {
          const batch = files.slice(i, i + batchSize);
          await Promise.all(batch.map(async f => {
            const txt = await fetch(f.download_url).then(r => r.text());
            parseFile(f.name, txt);
          }));
          done += batch.length;
          setStatus(`正在加载 ${done}/${files.length}`, Math.round(done / files.length * 100));
        }

        setStatus(`成功加载：${state.apps.size}个应用`, 100);
        renderResults($('#q').value.trim());
        saveToCache();
      };

      const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

      const main = () => {
        $('#reload').onclick = () => {
          state.apps.clear();
          load().catch(e => { setStatus('失败', 100); alert(e.message); });
        };

        $('#q').addEventListener('input', debounce(e => renderResults(e.target.value.trim()), 120));
        attachEvents();
        $('#q').focus({ preventScroll: true });
        $('#q').addEventListener('keydown', e => { if (e.key === 'Enter') e.target.blur(); });

        if (!loadFromCache()) {
          load().catch(e => { setStatus('失败', 100); alert(e.message); });
        }

        const backBtn = document.getElementById('backToTop');
        window.addEventListener('scroll', () => {
          if (window.scrollY > 200) backBtn.classList.add('visible');
          else backBtn.classList.remove('visible');
        });
        backBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      };

      main();
    })();
  </script>
</body>

</html>
