<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>模块助手</title>
  <link rel="icon" href="https://github.githubassets.com/favicons/favicon.svg" type="image/svg+xml" />
  <style>
    :root {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --card: #f7f7f8;
      --border: #e5e7eb;
      --accent: #2563eb;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0c0f;
        --fg: #e5e7eb;
        --muted: #a1a1aa;
        --card: #111317;
        --border: #25262b;
        --accent: #60a5fa;
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand h1 {
      font-size: 18px;
      margin: 0;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      transition: all 0.3s ease;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      flex: 1;
    }

    @media(min-width:720px) {
      .controls {
        justify-content: flex-end;
        flex-wrap: nowrap;
      }
    }

    input[type="text"] {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--fg);
      outline: none;
      max-width: 360px;
    }

    button,
    .btn {
      padding: 9px 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      cursor: pointer;
      transition: none;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 18px;
    }

    .card {
      grid-column: span 12;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    @media(min-width:720px) {
      .card {
        grid-column: span 6;
      }
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .card pre {
      margin: 10px 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 10px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 13px;
    }

    .meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .progress-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .progress {
      height: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden;
      flex: 1;
      transition: all 0.3s ease;
    }

    .progress>i {
      display: block;
      height: 100%;
      width: 0;
      background: var(--accent);
      transition: width .25s ease;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: var(--card);
      color: var(--fg);
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    @media(max-width: 600px) {
      .modal-content {
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
    }

    .modal-header {
      flex: 0 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--card);
      z-index: 10;
    }

    #modalBody {
      flex: 1 1 auto;
      padding: 12px 16px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      background: var(--card);
      border-radius: 0 0 16px 16px;
      font-size: 13px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 18px;
      color: var(--muted);
      padding: 2px 6px;
      border-radius: 6px;
      background: var(--card);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M4 12a8 8 0 1 1 16 0v6.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 4 18.5V12Z" stroke="currentColor"
            stroke-width="1.5" />
          <path d="M9 19v-5a3 3 0 1 1 6 0v5" stroke="currentColor" stroke-width="1.5" />
        </svg>
        <h1>模块助手</h1>
      </div>
      <div class="controls-row">
        <div class="controls">
          <input id="q" type="text" placeholder="输入应用名称" autofocus />
          <button id="reload" class="btn">重新拉取</button>
        </div>
        <div class="progress-row" style="margin-top:6px;">
          <div class="progress"><i id="bar"></i></div>
          <span id="status" class="badge">已就绪</span>
        </div>
      </div>
    </div>

    <div id="results" class="grid"></div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>原始规则（需转换后使用）</h3>
        <span class="modal-close" id="modalClose">✕</span>
      </div>
      <pre id="modalBody"></pre>
    </div>
  </div>

  <script>
    (() => {
      const state = { owner: 'XiangwanGuan', repo: 'Shadowrocket', path: 'Release/Modules', apps: new Map() };
      const $ = s => document.querySelector(s);

      const setStatus = (t, p) => {
        $('#status').textContent = t;
        $('#bar').style.width = (p || 0) + '%';
      };

      const extractDomains = txt => {
        const domains = new Set();
        const lines = txt.split(/\r?\n/);
        for (const line of lines) {
          if (/^hostname\s*=/.test(line.trim())) {
            let rhs = line.split('=')[1] || '';
            rhs = rhs.replace(/#.*/, '').trim();
            rhs = rhs.replace(/%APPEND%/g, '').trim();
            rhs.split(/[,\s]+/).map(x => x.trim()).filter(Boolean).forEach(d => domains.add(d));
          }
        }
        return domains;
      };

      const antiKill = txt => {
        const domains = new Set();
        const lines = txt.split(/\r?\n/);
        for (const line of lines) {
          if (/^hostname\s*=/.test(line.trim())) {
            let rhs = line.split('=')[1] || '';
            rhs = rhs.replace(/#.*/, '').trim();
            rhs = rhs.replace(/%APPEND%/g, '').trim();
            rhs.split(/[,\s]+/).map(x => x.trim()).filter(Boolean).forEach(d => domains.add(d.replace(/^-/, '')));
          }
        }

        if (!domains.size) return '';

        const line = `hostname = %APPEND% ${[...domains].map(d => `-${d}`).join(',')}`;
        return `[MITM]\n${line}`;
      };


      const parseFile = (name, txt) => {
        const appName = name.replace(/\.sgmodule$/i, '');
        const domains = extractDomains(txt);
        state.apps.set(appName, {
          domains,
          raw: txt,
          rule: antiKill(txt)
        });
      };

      const fuzzyMatch = (text, query) => {
        if (!query) return true;
        text = text.toLowerCase(); query = query.toLowerCase();
        if (text.includes(query)) return true;
        let i = 0;
        for (const c of text) { if (c === query[i]) i++; if (i === query.length) return true; }
        return false;
      };

      const renderResults = q => {
        const root = $('#results'); root.innerHTML = '';
        const entries = [...state.apps.entries()].sort((a, b) => a[0].localeCompare(b[0]));
        const matched = q ? entries.filter(([k]) => fuzzyMatch(k, q)) : entries;

        for (const [app, data] of matched) {
          const domains = data.domains;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<h3>${app}</h3>
        <div class="meta">
          <span class="badge">解密域名：${domains.size}</span>
          <button class="btn" data-copy>复制反误杀规则</button>
          <button class="btn" data-raw>查看原始规则</button>
        </div>
        <pre class="code">${[...domains].join('\n')}</pre>`;
          root.appendChild(card);
        }
      };

      const attachEvents = () => {
        const modal = $('#modal');
        const closeBtn = $('#modalClose');

        $('#results').addEventListener('click', e => {
          const card = e.target.closest('.card'); if (!card) return;
          const app = card.querySelector('h3').innerText;
          const data = state.apps.get(app);

          if (e.target.matches('[data-copy]')) {
            navigator.clipboard.writeText(data.rule).then(() => { e.target.textContent = '规则复制成功'; });
          }

          if (e.target.matches('[data-raw]')) {
            $('#modalBody').textContent = data.raw;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
          }
        });

        closeBtn.onclick = () => { modal.classList.remove('show'); setTimeout(() => modal.style.display = 'none', 200); };
        modal.onclick = e => { if (e.target.id === 'modal') closeBtn.click(); };
      };

      const fetchJSON = async url => {
        const r = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
        if (!r.ok) throw new Error(r.status + ': ' + (await r.text()));
        return r.json();
      };

      const load = async () => {
        state.apps.clear();
        setStatus('正在加载目录', 5);

        const list = await fetchJSON(`https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}`);
        const files = list.filter(x => x.type === 'file');
        let done = 0;

        const batchSize = 20;
        for (let i = 0; i < files.length; i += batchSize) {
          const batch = files.slice(i, i + batchSize);
          await Promise.all(batch.map(async f => {
            const txt = await fetch(f.download_url).then(r => r.text());
            parseFile(f.name, txt);
          }));
          done += batch.length;
          setStatus(`加载进度 ${done}/${files.length}`, Math.round(done / files.length * 100));
        }

        setStatus(`成功加载：${state.apps.size}个应用`, 100);
        renderResults($('#q').value.trim());
      };

      const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

      const main = () => {
        $('#reload').onclick = () => load().catch(e => { setStatus('失败', 100); alert(e.message); });
        $('#q').addEventListener('input', debounce(e => renderResults(e.target.value.trim()), 120));
        attachEvents();
        $('#q').focus({ preventScroll: true });
        $('#q').addEventListener('keydown', e => { if (e.key === 'Enter') e.target.blur(); });

        load().catch(e => { setStatus('失败', 100); alert(e.message); });
      };

      main();
    })();
  </script>
</body>

</html>