<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>规则助手</title>
  <link rel="icon" href="https://github.githubassets.com/favicons/favicon.svg" type="image/svg+xml" />
  <style>
    :root {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --card: #f7f7f8;
      --border: #e5e7eb;
      --accent: #2563eb
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0c0f;
        --fg: #e5e7eb;
        --muted: #a1a1aa;
        --card: #111317;
        --border: #25262b;
        --accent: #60a5fa
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Apple Color Emoji, Segoe UI Emoji
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px
    }

    .header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap
    }

    .brand {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .brand h1 {
      font-size: 18px;
      margin: 0
    }

    small {
      color: var(--muted)
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    input[type="text"] {
      width: 360px;
      max-width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--fg);
      outline: none
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 30%, transparent)
    }

    button,
    .btn {
      padding: 9px 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      cursor: pointer
    }

    button.primary {
      background: var(--accent);
      border-color: transparent;
      color: #fff
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      color: var(--muted)
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 18px
    }

    .card {
      grid-column: span 12;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 14px
    }

    @media(min-width:720px) {
      .card {
        grid-column: span 6
      }
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 16px
    }

    .card pre {
      margin: 10px 0;
      border: 1px dashed var(--border);
      padding: 10px;
      border-radius: 12px;
      overflow: auto;
      max-height: 400px;
      background: transparent;
      white-space: pre-wrap
    }

    .meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .footer {
      margin-top: 26px;
      color: var(--muted)
    }

    .progress {
      height: 6px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden
    }

    .progress>i {
      display: block;
      height: 100%;
      width: 0;
      background: var(--accent);
      transition: width .25s ease
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000
    }

    .modal-content {
      background: var(--card);
      color: var(--fg);
      border-radius: 16px;
      max-width: 90%;
      max-height: 80%;
      padding: 16px;
      overflow: auto;
      border: 1px solid var(--border)
    }

    .modal-content h3 {
      margin-top: 0
    }

    .modal-close {
      float: right;
      cursor: pointer;
      font-size: 18px;
      color: var(--muted)
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 12a8 8 0 1 1 16 0v6.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 4 18.5V12Z" stroke="currentColor"
            stroke-width="1.5" />
          <path d="M9 19v-5a3 3 0 1 1 6 0v5" stroke="currentColor" stroke-width="1.5" />
        </svg>
        <h1>规则助手</h1>
      </div>
      <div class="controls">
        <input id="q" type="text" placeholder="输入应用名称" />
        <button id="reload" class="btn">重新拉取</button>
      </div>
      <div class="row" style="width:100%;margin-top:6px">
        <div style="flex:1" class="progress"><i id="bar"></i></div>
        <span id="status" class="badge">已就绪</span>
      </div>
    </div>

    <div id="results" class="grid"></div>
  </div>

  <div id="modal" class="modal" style="display:none">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">✕</span>
      <h3>原始规则（需转换后使用，Shadowrocket无法直接运行）</h3>
      <pre id="modalBody" class="code"></pre>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const state = { owner: 'XiangwanGuan', repo: 'Shadowrocket', path: 'Rewrite/XiangwanConfig', apps: new Map(), rawFiles: [], loaded: false };

    function setStatus(t, p) {
      $('#status').textContent = t;
      $('#bar').style.width = (p || 0) + '%'
    }

    function normalizeAppName(s) {
      return s.trim().replace(/^#\s*>\s*/, '')
    }

    function tokenizeDomains(line) {
      let r = line.split('=')[1] || '';
      r = r.replace(/#.*/, '').replace(/；/g, ',').replace(/，/g, ',');
      return r.split(/[,\s]+/).map(x => x.trim()).filter(Boolean)
    }

    function parseFile(txt) {
      const lines = txt.split(/\r?\n/);
      let cur = null;
      let buffer = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (/^#\s*>/.test(line.trim())) {
          if (cur && buffer.length) {
            state.apps.get(cur).raw = buffer.join("\n");
            buffer = []
          }
          cur = normalizeAppName(line);
          if (!state.apps.has(cur)) state.apps.set(cur, { domains: new Set(), raw: '' });
          continue
        }
        if (!cur) continue;
        if (/#\s*-{2,}\s*.+-{2,}\s*#/.test(line)) continue;
        buffer.push(line);
        if (/^hostname\s*=/.test(line.trim())) {
          tokenizeDomains(line).forEach(d => state.apps.get(cur).domains.add(d))
        }
      }
      if (cur && buffer.length) { state.apps.get(cur).raw = buffer.join("\n") }
    }

    function antiKill(domains) {
      const ds = [...domains].map(d => d.replace(/^-/, '').trim()).filter(Boolean);
      return `hostname = %APPEND% ${ds.map(d => `-${d}`).join(', ')}`
    }

    function fuzzyMatch(text, query) {
      if (!query) return true;
      text = text.toLowerCase();
      query = query.toLowerCase();
      if (text.includes(query)) return true;
      let i = 0;
      for (const c of text) {
        if (c === query[i]) i++;
        if (i === query.length) return true
      }
      return false
    }

    function renderResults(q) {
      const root = $('#results'); root.innerHTML = '';
      const entries = [...state.apps.entries()].sort((a, b) => a[0].localeCompare(b[0]));
      const matched = q ? entries.filter(([k]) => fuzzyMatch(k, q)) : [];
      if (!matched.length) return;
      for (const [app, data] of matched) {
        const domains = data.domains;
        const rule = antiKill(domains);
        const domainList = [...domains].join('\n');
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<h3>${app}</h3>
<div class="meta">
  <span class="badge">域名 ${domains.size}</span>
  <button class="btn" data-copy>复制反误杀规则</button>
  <button class="btn" data-raw>查看原始规则</button>
</div>
<pre class="code" data-rule-copy="${rule}">${domainList}</pre>`;
        root.appendChild(card);
      }
    }

    function attachEvents() {
      $('#results').addEventListener('click', e => {
        if (e.target.matches('[data-copy]')) {
          const rule = e.target.closest('.card').querySelector('[data-rule-copy]').getAttribute('data-rule-copy');
          navigator.clipboard.writeText(rule);
        }
        if (e.target.matches('[data-raw]')) {
          const app = e.target.closest('.card').querySelector('h3').innerText;
          const raw = state.apps.get(app)?.raw || '';
          $('#modalBody').textContent = raw;
          $('#modal').style.display = 'flex';
        }
      });
      $('#modalClose').onclick = () => $('#modal').style.display = 'none';
      $('#modal').onclick = e => { if (e.target.id === 'modal') $('#modal').style.display = 'none' }
    }

    async function fetchJSON(url) {
      const r = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
      if (!r.ok) throw new Error(r.status + ': ' + (await r.text()));
      return r.json()
    }

    async function fetchText(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(r.status + ': ' + (await r.text()));
      return r.text()
    }

    async function load() {
      state.apps.clear(); state.rawFiles = []; setStatus('正在加载目录', 5);
      const list = await fetchJSON(`https://api.github.com/repos/${state.owner}/${state.repo}/contents/${state.path}`);
      const files = list.filter(x => x.type === 'file'); let done = 0;
      for (const f of files) {
        setStatus(`正在加载：${f.name}`, 10 + Math.round(done / files.length * 80));
        const txt = await fetchText(f.download_url);
        state.rawFiles.push({ name: f.name, txt });
        parseFile(txt);
        done++
      }
      state.loaded = true; setStatus(`成功加载：${state.apps.size}个应用`, 100)
    }

    function debounce(fn, ms) {
      let t;
      return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms) }
    }

    (function main() {
      $('#reload').onclick = () => load().catch(e => { setStatus('失败', 100); alert(e.message) });
      $('#q').addEventListener('input', debounce(e => renderResults(e.target.value.trim()), 120));
      attachEvents();
      load().catch(e => { setStatus('失败', 100); alert(e.message) })
    })();
  </script>
</body>

</html>
